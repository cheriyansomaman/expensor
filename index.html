<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Expensor</title>

    <!-- Material UI CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- Material UI styles -->
    <link rel="stylesheet" href="style.css">

    <link rel="manifest" href="manifest.webmanifest"/>
    <link rel="apple-touch-icon" href="icons/icon-192.png"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Expense Tracker">
    <meta name="theme-color" content="#1976d2"/>
</head>

<body>
<div class="page-content">
  <div class="container">
    <!-- Add Expense Page (default visible) -->
    <div id="add-expense-page" class="page">
      <div class="card">
          <h1 class="title">
              <i class="fas fa-wallet"></i> Expensor
          </h1>

          <form id="expense-form">
              <div class="form-grid">
                  <div class="form-field">
                      <label for="category"><i class="fas fa-tag"></i> Category</label>
                      <input type="text" id="category" placeholder="e.g. Groceries" required/>
                  </div>

                  <div class="form-field">
                      <label for="amount"><i class="fas fa-pound-sign"></i> Amount</label>
                      <input type="number" step="0.01" id="amount" placeholder="0.00" required/>
                  </div>

                  <div class="form-field">
                      <label for="date"><i class="fas fa-calendar-alt"></i> Date</label>
                      <input type="date" id="date"/>
                  </div>

                  <div class="form-field">
                      <label for="note"><i class="fas fa-sticky-note"></i> Note</label>
                      <input type="text" id="note" placeholder="Optional note"/>
                  </div>
              </div>

              <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Add Expense
              </button>
          </form>
      </div>
    </div>

    <!-- Expense History Page (hidden by default) -->
    <div id="expense-history-page" class="page" style="display: none;">
      <div class="card">
          <div class="header-row">
              <h2 class="title">
                  <i class="fas fa-list"></i> Expense History
              </h2>
              <button id="refresh-btn" class="btn btn-icon" title="Refresh">
                  <i class="fas fa-sync-alt"></i>
              </button>
          </div>

          <div class="table-container">
              <table>
                  <thead>
                  <tr>
                      <th><i class="fas fa-calendar"></i> Date</th>
                      <th><i class="fas fa-pound-sign"></i> Amount</th>
                      <th><i class="fas fa-tag"></i> Category</th>
                      <th><i class="fas fa-comment"></i> Note</th>
                      <th>Actions</th>
                  </tr>
                  </thead>
                  <tbody id="expense-table-body"></tbody>
              </table>
          </div>
      </div>
    </div>

    <!-- Monthly Summary Page (hidden by default) -->
    <div id="monthly-summary-page" class="page" style="display: none;">
      <div class="card">
          <h2 class="title">
              <i class="fas fa-chart-bar"></i> Monthly Summary
          </h2>
          <div class="chart-container">
              <canvas id="expense-chart"></canvas>
          </div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="nav-container">
  <nav class="nav-menu">
    <a href="#" class="nav-item active" data-page="add-expense-page">
      <i class="fas fa-plus-circle"></i>
      <span>Add Expense</span>
    </a>
    <a href="#" class="nav-item" data-page="expense-history-page">
      <i class="fas fa-list"></i>
      <span>History</span>
    </a>
    <a href="#" class="nav-item" data-page="monthly-summary-page">
      <i class="fas fa-chart-pie"></i>
      <span>Reports</span>
    </a>
  </nav>
</div>

<script src="config.js"></script>
<script type="module">
// Firebase config (replace with yours)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    doc,
    query,
    orderBy
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

const firebaseConfig = window.FIREBASE_CONFIG;

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const expenseCol = collection(db, "item");

let editingId = null;

// Navigation logic
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', function(e) {
    e.preventDefault();
    
    // Remove active class from all items
    document.querySelectorAll('.nav-item').forEach(navItem => {
      navItem.classList.remove('active');
    });
    
    // Add active class to clicked item
    this.classList.add('active');
    
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
      page.style.display = 'none';
    });
    
    // Show selected page
    const pageId = this.getAttribute('data-page');
    document.getElementById(pageId).style.display = 'block';
    
    // Load data if needed
    if (pageId === 'expense-history-page' || pageId === 'monthly-summary-page') {
      loadExpenses();
    }
  });
});

// Handle Form Submit
document.getElementById("expense-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const amountInput = document.getElementById("amount");
    const rawAmount = amountInput.value.trim();
    const validAmountRegex = /^\d+(\.\d{1,2})?$/;

    // Validate amount input
    if (!validAmountRegex.test(rawAmount)) {
        alert("Enter a valid amount (max two decimal places). E.g., 12, 12.5, 12.99");
        return;
    }

    const amount = parseFloat(rawAmount);
    const category = document.getElementById("category").value;
    let dateInput = document.getElementById("date").value;
    const date = dateInput || new Date().toISOString().split("T")[0];
    const note = document.getElementById("note").value;

    // Ensure all required fields are filled
    if (!amount || !category || !date) return alert("Fill all required fields");

    const submitBtn = document.querySelector("#expense-form button[type='submit']");
    
    // If we are in edit mode
    if (editingId) {
        const docRef = doc(db, "item", editingId);
        await updateDoc(docRef, { amount, category, date, note });
        editingId = null; // Reset the editingId after update
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Expense';
        submitBtn.classList.remove("btn-secondary");
        submitBtn.classList.add("btn-primary");
    } else {
        // If we are adding a new expense
        await addDoc(expenseCol, { amount, category, date, note });
    }

    e.target.reset(); // Reset the form fields after submission
    loadExpenses(); // Reload the expenses after adding/updating
});

// Load and Display
async function loadExpenses() {
    const q = query(expenseCol, orderBy("date", "desc"));
    const snapshot = await getDocs(q);
    const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const tbody = document.getElementById("expense-table-body");
    tbody.innerHTML = ""; // Clear existing table rows

    const monthlyTotal = {};

    expenses.forEach(exp => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${exp.date}</td>
            <td>£${exp.amount.toFixed(2)}</td>
            <td>${exp.category}</td>
            <td>${exp.note || "-"}</td>
            <td class="action-cell">
                <button class="edit-btn btn btn-warning btn-icon" data-id="${exp.id}" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn btn btn-error btn-icon" data-id="${exp.id}" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);

        const month = exp.date.slice(0, 7);
        monthlyTotal[month] = (monthlyTotal[month] || 0) + exp.amount;
    });

    attachRowHandlers(); // Attach edit/delete handlers
    renderChart(monthlyTotal); // Update chart with new data
}

// Edit/Delete Handlers
function attachRowHandlers() {
    document.querySelectorAll(".edit-btn").forEach(btn =>
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const snapshot = await getDocs(query(expenseCol));
            const docData = snapshot.docs.find(d => d.id === id)?.data();
            if (docData) {
                // Fill the form with data from the clicked expense
                document.getElementById("amount").value = docData.amount;
                document.getElementById("category").value = docData.category;
                document.getElementById("note").value = docData.note || "";
                document.getElementById("date").value = docData.date;
                
                editingId = id; // Store the id for editing
                
                const submitBtn = document.querySelector("#expense-form button[type='submit']");
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Expense';
                submitBtn.classList.remove("btn-primary");
                submitBtn.classList.add("btn-secondary");
                
                // Switch to add expense page
                document.querySelectorAll('.nav-item').forEach(navItem => {
                  navItem.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="add-expense-page"]').classList.add('active');
                document.querySelectorAll('.page').forEach(page => {
                  page.style.display = 'none';
                });
                document.getElementById('add-expense-page').style.display = 'block';
            }
        })
    );

    document.querySelectorAll(".delete-btn").forEach(btn =>
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (confirm("Are you sure you want to delete this expense?")) {
                await deleteDoc(doc(db, "item", id));
                loadExpenses(); // Reload expenses after delete
            }
        })
    );
}

// Chart.js logic
let chart;
function renderChart(data) {
    const labels = Object.keys(data).sort();
    const values = labels.map(label => data[label]);

    // Generate a color for each month based on the index
    const backgroundColors = labels.map((_, i) => 
        `hsl(${(i * 360 / labels.length)}, 70%, 60%)`
    );

    if (chart) chart.destroy(); // Destroy the previous chart if exists
    const ctx = document.getElementById("expense-chart").getContext("2d");

    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Monthly Expenses",
                data: values,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('60%)', '40%)')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `£${context.raw.toFixed(2)}`;
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: (value) => `£${value.toFixed(2)}`,
                    font: {
                        weight: 'bold'
                    },
                    color: '#333'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '£' + value;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

// Refresh button logic
document.getElementById("refresh-btn").addEventListener("click", async () => {
    const btn = document.getElementById("refresh-btn");
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    await loadExpenses();
    btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
});

// Initial load (show add expense page by default)
document.getElementById('add-expense-page').style.display = 'block';
</script>
</body>
</html>